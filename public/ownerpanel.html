<!doctype html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Owner Panel — Hidden</title>
  <style>
    :root{
      --bg:#07070b; --panel:#0b0b12; --accent:#00f2ff; --muted:#9aa;
      --card:#111218; --text:#eef;
    }
    html,body{height:100%;margin:0;font-family:Inter,Segoe UI,Arial;background:linear-gradient(180deg,#03030a 0%, #07071a 100%);color:var(--text)}
    .top{height:60px;padding:10px 16px;display:flex;align-items:center;gap:12px;border-bottom:1px solid rgba(255,255,255,0.03);background:linear-gradient(90deg,#06060a, #0b0b12)}
    .brand{font-weight:700;color:var(--accent);font-size:18px}
    .wrap{display:flex;height:calc(100vh - 60px);}
    .left{width:320px;background:var(--panel);border-right:1px solid rgba(255,255,255,0.03);padding:12px;overflow:auto}
    .mid{flex:1;padding:14px;overflow:auto}
    .btn{background:var(--accent);color:#000;padding:8px 10px;border-radius:8px;border:none;cursor:pointer;font-weight:700}
    .small{font-size:13px;color:var(--muted)}
    .section-title{font-size:13px;color:var(--muted);margin:10px 0 8px}
    .user-item{padding:8px;border-radius:8px;margin-bottom:8px;background:linear-gradient(180deg,#08080c,#05050a);cursor:pointer;border:1px solid rgba(255,255,255,0.02)}
    .user-item:hover{transform:translateY(-1px)}
    .panel{background:var(--card);padding:12px;border-radius:8px;border:1px solid rgba(255,255,255,0.02)}
    .row{display:flex;gap:8px;align-items:center}
    .muted{color:var(--muted);font-size:13px}
    .partners-list > div{padding:8px;border-bottom:1px solid rgba(255,255,255,0.02);cursor:pointer}
    pre{background:#000;padding:10px;border-radius:8px;color:#ddd;overflow:auto}
    input,select,textarea{width:100%;padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.06);background:transparent;color:var(--text)}
    .flex{display:flex;gap:8px}
    .chip{display:inline-block;padding:6px 8px;background:#051; border-radius:8px;color:#bff;font-size:13px;margin-right:6px}
    footer{padding:10px;text-align:center;color:var(--muted);font-size:13px}
    @media(max-width:900px){
      .left{width:240px}
      .wrap{flex-direction:column}
      .mid{height:calc(100vh - 200px);overflow:auto}
    }
  </style>
</head>
<body>
  <div class="top">
    <div class="brand">OWNER PANEL <span class="small" style="margin-left:10px">— Hidden Monitoring & Controls</span></div>
    <div style="flex:1"></div>
    <div class="small">Tip: Do not share this URL</div>
  </div>

  <div class="wrap">
    <!-- LEFT: Controls / Online list -->
    <div class="left">
      <div class="section-title">Owner Token</div>
      <div class="panel">
        <div class="small">Token supplied via query param <code>?token=...</code></div>
        <div style="margin-top:8px">
          <input id="tokenInput" placeholder="(optional) paste token here" />
          <div style="margin-top:8px" class="flex">
            <button id="btnSetToken" class="btn">Use Token</button>
            <button id="btnRefresh" class="btn" style="background:#66f">Refresh</button>
          </div>
        </div>
      </div>

      <div class="section-title">Online Users</div>
      <div id="onlineList" class="panel" style="padding:8px;min-height:150px">Loading...</div>

      <div class="section-title" style="margin-top:12px">Search / Quick Actions</div>
      <div class="panel">
        <input id="searchUser" placeholder="Search username..." />
        <div style="margin-top:8px" class="flex">
          <button id="btnSearch" class="btn">Search</button>
          <button id="btnListAll" class="btn" style="background:#66f">All</button>
        </div>
        <div style="margin-top:12px">
          <button id="btnLoadAlerts" class="btn" style="width:100%">Load Alerts</button>
        </div>
      </div>

      <div style="height:18px"></div>
      <div class="section-title">Alerts</div>
      <div id="alertsBox" class="panel" style="min-height:120px;max-height:240px;overflow:auto">—</div>

      <footer>Owner: hidden mode — use safely</footer>
    </div>

    <!-- MIDDLE: Selected user, partners, DM viewer, logs -->
    <div class="mid">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:12px">
        <div style="flex:1">
          <h2 id="midTitle">Monitor</h2>
          <div class="small">Select a user on left to inspect DM partners / threads / device & IP info</div>
        </div>
        <div style="min-width:260px">
          <div class="small">Selected user:</div>
          <div id="selectedUser" style="font-weight:700;color:var(--accent);margin-top:6px">— none —</div>
        </div>
      </div>

      <div style="display:flex;gap:12px">
        <div style="width:320px">
          <div class="section-title">DM Partners</div>
          <div id="partnersBox" class="panel partners-list" style="min-height:240px">—</div>

          <div class="section-title" style="margin-top:12px">Device & IP</div>
          <div id="deviceInfo" class="panel small">—</div>

          <div style="margin-top:12px" class="section-title">Admin Controls (Owner)</div>
          <div class="panel">
            <div class="small">Actions will be implemented server-side</div>
            <div style="margin-top:8px" class="flex">
              <button id="btnKick" class="btn" style="background:#f44">Kick</button>
              <button id="btnMute" class="btn">Mute</button>
            </div>
            <div style="margin-top:8px" class="flex">
              <button id="btnBlock" class="btn">Block</button>
              <button id="btnUnblock" class="btn" style="background:#66f">Unblock</button>
            </div>
          </div>
        </div>

        <div style="flex:1">
          <div class="section-title">DM Thread Viewer</div>
          <div id="dmThread" class="panel" style="min-height:300px;max-height:60vh;overflow:auto">Select a partner to load thread</div>

          <div style="margin-top:12px" class="section-title">Activity Logs</div>
          <div id="logsBox" class="panel" style="min-height:160px;max-height:30vh;overflow:auto">—</div>
        </div>
      </div>

    </div>
  </div>

  <script>
  // Minimal inline helpers so ownerpanel.js can be optional; token from URL or input
  (function(){
    function qs(name){ const u=new URL(location.href); return u.searchParams.get(name); }
    const initialToken = qs('token') || '';
    document.getElementById('tokenInput').value = initialToken;
    document.getElementById('btnSetToken').onclick = ()=> {
      const t = document.getElementById('tokenInput').value.trim();
      if(!t) return alert('Paste owner token');
      window.OWNER_TOKEN = t;
      loadAll();
      alert('Token set — loaded');
    };
    document.getElementById('btnRefresh').onclick = ()=> loadAll();
    document.getElementById('btnListAll').onclick = ()=> loadOnline();
    document.getElementById('btnLoadAlerts').onclick = ()=> loadAlerts();
    document.getElementById('btnSearch').onclick = ()=> {
      const q=document.getElementById('searchUser').value.trim();
      if(!q) return alert('enter username');
      searchUser(q);
    };
    // if token present auto-use
    if(initialToken) { window.OWNER_TOKEN = initialToken; setTimeout(loadAll, 300); }

    // export some functions for ownerpanel.js to call if loaded externally
    window._ownerHelpers = {
      setToken: (t)=>{ window.OWNER_TOKEN = t; document.getElementById('tokenInput').value = t; loadAll(); },
    };

    // --- core fetch helpers (used by ownerpanel.js or inline)
    async function apiGET(path){
      if(!window.OWNER_TOKEN) return alert('owner token not set');
      const sep = path.includes('?') ? '&' : '?';
      const res = await fetch(path + sep + 'token=' + encodeURIComponent(window.OWNER_TOKEN));
      return res.json();
    }

    // load online
    async function loadOnline(){
      const out = document.getElementById('onlineList');
      out.innerHTML = 'Loading...';
      try{
        const res = await apiGET('/owner/online');
        if(!res.ok) { out.innerHTML = '<div class="small">No permission or invalid token</div>'; return; }
        if(!res.users || !res.users.length){ out.innerHTML = '<div class="small">No users online</div>'; return; }
        out.innerHTML = res.users.map(u => `<div class="user-item" onclick="selectOwnerUser('${u.username.replace(/'/g,"\\'")}')">${u.username}</div>`).join('');
      }catch(e){ out.innerHTML = '<div class="small">Error loading</div>'; console.error(e); }
    }

    // select user (global)
    window.selectOwnerUser = function(username){
      document.getElementById('selectedUser').textContent = username;
      window.SELECTED_USER = username;
      document.getElementById('partnersBox').innerHTML = 'Loading...';
      loadPartners(username);
      loadDeviceInfo(username);
      loadLogs();
    };

    async function loadPartners(user){
      try{
        const res = await apiGET('/owner/dm-partners?user=' + encodeURIComponent(user));
        if(!res.ok) { document.getElementById('partnersBox').innerHTML = '<div class="small">No permission</div>'; return; }
        if(!res.list || !res.list.length){ document.getElementById('partnersBox').innerHTML = '<div class="small">No partners</div>'; return; }
        document.getElementById('partnersBox').innerHTML = res.list.map(p => `<div onclick="loadThread('${user}','${p.replace(/'/g,"\\'")}')">${p}</div>`).join('');
      }catch(e){ document.getElementById('partnersBox').innerHTML = '<div class="small">Error</div>'; console.error(e); }
    }

    async function loadDeviceInfo(user){
      try{
        const res = await apiGET('/owner/userinfo?user=' + encodeURIComponent(user));
        if(!res.ok){ document.getElementById('deviceInfo').innerHTML = '<div class="small">No permission</div>'; return; }
        const d = res.info;
        document.getElementById('deviceInfo').innerHTML = `<div class="small">Devices:</div><div>${(d.devices||[]).map(x=>'<span class="chip">'+x+'</span>').join(' ')}</div>
          <div style="margin-top:8px" class="small">IPs:</div><div>${(d.ips||[]).map(x=>'<span class="chip">'+x+'</span>').join(' ')}</div>`;
      }catch(e){ document.getElementById('deviceInfo').innerHTML = '<div class="small">Error</div>'; console.error(e); }
    }

    async function loadLogs(){
      try{
        const res = await apiGET('/owner/logs');
        if(!res.ok){ document.getElementById('logsBox').innerHTML = '<div class="small">No permission</div>'; return; }
        document.getElementById('logsBox').innerHTML = res.list.map(l => `<pre>${new Date(l.time).toLocaleString()}\n${l.type}\n${JSON.stringify(l.data,null,2)}</pre>`).join('');
      }catch(e){ document.getElementById('logsBox').innerHTML = '<div class="small">Error</div>'; console.error(e); }
    }

    async function loadAlerts(){
      try{
        const res = await apiGET('/owner/alerts');
        if(!res.ok){ document.getElementById('alertsBox').innerHTML = '<div class="small">No permission</div>'; return; }
        document.getElementById('alertsBox').innerHTML = res.alerts.map(a => `<div style="padding:8px;border-bottom:1px solid rgba(255,255,255,0.03)"><b>${a.type}</b><div class="small">${new Date(a.time).toLocaleString()}</div></div>`).join('');
      }catch(e){ document.getElementById('alertsBox').innerHTML = '<div class="small">Error</div>'; console.error(e); }
    }

    async function loadThread(a,b){
      try{
        const res = await apiGET('/owner/read-dm?a=' + encodeURIComponent(a) + '&b=' + encodeURIComponent(b));
        if(!res.ok){ document.getElementById('dmThread').innerHTML = '<div class="small">No permission</div>'; return; }
        document.getElementById('dmThread').innerHTML = res.thread.map(m => `<div style="margin-bottom:10px"><b>${m.from}</b>: ${m.text || ''} ${m.file?'<i>[file]</i>':''}</div>`).join('');
      }catch(e){ document.getElementById('dmThread').innerHTML = '<div class="small">Error</div>'; console.error(e); }
    }

    // expose some functions globally used in markup
    window.loadAll = function(){ loadOnline(); loadLogs(); loadAlerts(); };
    window.loadPartners = loadPartners;
    window.loadThread = loadThread;
    window.loadOnline = loadOnline;
    window.searchUser = async function(q){ 
      // simple search: fetch online and filter
      const res = await apiGET('/owner/online'); 
      if(!res.ok) return alert('no permission'); 
      const found = (res.users||[]).map(u=>u.username).filter(name => name.includes(q));
      document.getElementById('onlineList').innerHTML = found.map(u=>`<div class="user-item" onclick="selectOwnerUser('${u}')">${u}</div>`).join('') || '<div class="small">No user found</div>';
    };

    // if token was prefilled, auto-load
    if(initialToken) loadAll();

    // Hook action buttons (Kick/Block etc) - these require server endpoints (implement later)
    document.getElementById('btnKick').onclick = async ()=> {
      const u = window.SELECTED_USER;
      if(!u) return alert('Select user');
      if(!confirm('Kick user '+u+' ?')) return;
      const res = await fetch('/owner/action/kick', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: window.OWNER_TOKEN, user: u })});
      const j = await res.json();
      alert(j.ok ? 'Kicked' : 'Failed');
      loadOnline();
    };
    document.getElementById('btnBlock').onclick = async ()=> {
      const u = window.SELECTED_USER;
      if(!u) return alert('Select user');
      const res = await fetch('/owner/action/block', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: window.OWNER_TOKEN, user: u })});
      const j = await res.json();
      alert(j.ok ? 'Blocked' : 'Failed');
      loadOnline();
    };
    document.getElementById('btnUnblock').onclick = async ()=> {
      const u = window.SELECTED_USER;
      if(!u) return alert('Select user');
      const res = await fetch('/owner/action/unblock', { method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({ token: window.OWNER_TOKEN, user: u })});
      const j = await res.json();
      alert(j.ok ? 'Unblocked' : 'Failed');
      loadOnline();
    };

    // attach dynamic loader for partner click
    window.loadThread = loadThread;
    window.loadPartners = loadPartners;

    // helper to set token from console if needed
    console.log('Owner Panel loaded. Use owner token in query param or paste in token box.');
  })();
  </script>
</body>
</html>
